app-id: io.github.ocrmypdf.ocrmypdf
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: ocrmypdf
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.llvm19
build-options:
  append-path: '/usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/llvm19/bin'
  env:
    CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
    CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: '-C link-arg=-fuse-ld=/usr/lib/sdk/rust-stable/bin/mold'
    CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: clang
    CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS: '-C link-arg=-fuse-ld=/usr/lib/sdk/rust-stable/bin/mold'

finish-args:
  - --filesystem=home

modules:
  - name: leptonica
    sources:
      - type: git
        url: https://github.com/DanBloomberg/leptonica.git
        tag: 1.85.0
        commit: 63aef18d98432b8582a1565e241f7bd2ee9cc8d9
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$

  - name: tesseract
    config-opts:
      - --disable-graphics
    sources:
      - type: git
        url: https://github.com/tesseract-ocr/tesseract.git
        tag: 5.5.0
        commit: 64eab6c457b2337dd690746a5fde5c222b40d5f8
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$

  - name: tessdata_fast # downloads all -> TODO: choose languages
    buildsystem: simple
    build-commands:
      - rm -rf ${FLATPAK_DEST}/share/tessdata
      - mkdir -p ${FLATPAK_DEST}/share/tessdata
      - cp -av * ${FLATPAK_DEST}/share/tessdata/
    sources:
      - type: git
        url: https://github.com/tesseract-ocr/tessdata_fast
        tag: 4.1.0
        commit: 65727574dfcd264acbb0c3e07860e4e9e9b22185

  - name: ghostscript
    config-opts:
      - "--disable-cups"
    make-args:
      - so
    make-install-args:
      - soinstall
    post-install:
      - "mv -f ${FLATPAK_DEST}/bin/{gsc,gs} "
    cleanup:
      - /share/ghostscript/*/doc/
      - /share/ghostscript/*/examples
    sources:
      - type: git
        url: https://github.com/ArtifexSoftware/ghostpdl-downloads.git
        tag: gs10040
        commit: 08ae03dc175313a85e8cc053610d10321724e1f2
        x-checker-data:
          - type: git
            tag-pattern: ^gs([\\d]+)$

  - name: jbig2enc
    sources:
      - type: git
        url: https://github.com/agl/jbig2enc.git
        tag: 0.30
        commit: cbca93f49921e6702f61031b6717575237636815
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$

  - name: pngquant
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm 755 target/release/pngquant -t /app/bin
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/pngquant/cargo
    sources:
      - type: git
        url: https://github.com/kornelski/pngquant.git
        tag: 3.0.3
        commit: 53a332a58f44357b6b41842a54d74aa1e245913d
        x-checker-data:
          - type: git
            tag-pattern: ^([\\d.]+)$
      - cargo-sources-pngquant.json # pngquant does not ship a Cargo.lock file, needs to be generated and converted

  - python3-sphinx.yml # needed to build unpaper

  - name: unpaper
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/unpaper/unpaper.git
        tag: unpaper-7.0.0
        commit: 5211a623d48858eae154213a61bccbc368b19ca0
        x-checker-data:
          - type: git
            tag-pattern: ^(unpaper-[\\d.]+)$

  - flatpak-module-qpdf-pikepdf/pikepdf.yaml

  # TODO: organize these python modules, figure out how to deal with rust dependencies
  - python3-setuptools_rust.yml # needed to build maturin and cryptography
  - python3-maturin.yml # needed to package some of the python packages, add cargo manually
  - python3-cryptography.yml # add cargo manually
  - python3-hatchling.yml # dep of pygments
  - python3-pygments.yml # part of Sdk but not of runtime, have to add manually
  - python3-ocrmypdf.yml
