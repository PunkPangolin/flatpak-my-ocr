app-id: io.github.ocrmypdf.ocrmypdf
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: ocrmypdf
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin

finish-args:
  - --filesystem=home

modules:
  - name: leptonica
    sources:
      - type: git
        url: https://github.com/DanBloomberg/leptonica.git
        tag: 1.85.0
        commit: 63aef18d98432b8582a1565e241f7bd2ee9cc8d9
        x-checker-data:
          - type: git
            tag-pattern: ^([\d.]+)$

  - name: tesseract
    config-opts:
      - --disable-graphics
    sources:
      - type: git
        url: https://github.com/tesseract-ocr/tesseract.git
        tag: 5.5.0
        commit: 64eab6c457b2337dd690746a5fde5c222b40d5f8
        x-checker-data:
          - type: git
            tag-pattern: ^([\d.]+)$

  - name: tessdata_fast # downloads all -> TODO: choose languages
    buildsystem: simple
    build-commands:
      - rm -rf ${FLATPAK_DEST}/share/tessdata
      - mkdir -p ${FLATPAK_DEST}/share/tessdata
      - cp -av * ${FLATPAK_DEST}/share/tessdata/
    sources:
      - type: git
        url: https://github.com/tesseract-ocr/tessdata_fast
        tag: 4.1.0
        commit: 65727574dfcd264acbb0c3e07860e4e9e9b22185

  - name: ghostscript
    config-opts:
      - "--disable-cups"
    cleanup:
      - /share/ghostscript/*/doc/
      - /share/ghostscript/*/examples
    sources:
      - type: git
        url: git://git.ghostscript.com/ghostpdl.git
        tag: ghostpdl-10.04.0
        commit: df8f4966577fff70320be2eb33cb55eb15d05d52
        x-checker-data:
          - type: git
            tag-pattern: ^(ghostpdl-[\d.]+)$

  - name: jbig2enc
    sources:
      - type: git
        url: https://github.com/agl/jbig2enc.git
        tag: 0.30
        commit: cbca93f49921e6702f61031b6717575237636815
        x-checker-data:
          - type: git
            tag-pattern: ^([\d.]+)$

  - name: pngquant
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm 755 target/release/pngquant -t /app/bin
    build-options:
      env:
        CARGO_HOME: /run/build/pngquant/cargo
    sources:
      - type: git
        url: https://github.com/kornelski/pngquant.git
        tag: 3.0.3
        commit: 53a332a58f44357b6b41842a54d74aa1e245913d
        x-checker-data:
          - type: git
            tag-pattern: ^([\d.]+)$
      - cargo-sources-pngquant.json # pngquant does not ship a Cargo.lock file, needs to be generated and converted

  - name: unpaper
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/unpaper/unpaper.git
        tag: unpaper-7.0.0
        commit: 5211a623d48858eae154213a61bccbc368b19ca0
        x-checker-data:
          - type: git
            tag-pattern: ^(unpaper-[\d.]+)$
    modules:
      - python3-sphinx.yaml

  - flatpak-module-qpdf-pikepdf/pikepdf.yaml

  # Contains ocrmypdf and dependencies
  # setuptools_rust maturin cffi cryptography hatchling pygments ocrmypdf
  # add cargo env and cargo sources for maturin and cryptography
  # add pygments (left out by flatpak-pip-generator because it is part of the Sdk)
  - python3-ocrmypdf.yaml
